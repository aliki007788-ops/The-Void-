<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self' https://t.me wss://*.t.me;
                   script-src 'self' 'unsafe-inline' https://telegram.org;
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                   font-src https://fonts.gstatic.com;
                   img-src 'self' data: blob:;
                   connect-src 'self' https://api.telegram.org;">
    <title>THE VOID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#FFD700;font-family:'Cinzel',serif}
        canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none}
        .page{position:absolute;width:100%;height:100%;opacity:0;transition:opacity 1.5s ease;display:flex;flex-direction:column;align-items:center;padding:20px;box-sizing:border-box;overflow-y:auto}
        .page.active{opacity:1;z-index:10}
        .main-title{font-size:3.5rem;letter-spacing:20px;margin:60px 0;text-shadow:0 0 50px #FFD700;border-bottom:3px solid #FFD700;padding-bottom:20px}
        input[type=text]{background:transparent;border:none;border-bottom:2px solid #FFD700;color:#FFD700;font-size:1.6rem;text-align:center;width:90%;margin:50px 0;outline:none}
        .btn{background:transparent;border:2px solid #FFD700;color:#FFD700;padding:18px 40px;margin:15px;font-size:1.4rem;cursor:pointer;border-radius:15px;transition:.4s;box-shadow:0 0 40px rgba(255,215,0,.5)}
        .btn:hover{background:rgba(255,215,0,.2);transform:scale(1.1);box-shadow:0 0 70px rgba(255,215,0,.8)}
        .btn-luck{background:linear-gradient(45deg,#8B00FF,#FF00FF,#FFD700);animation:pulse 2s infinite;border:none;color:#fff;font-size:1.8rem}
        .glass-card{background:rgba(255,255,255,.05);backdrop-filter:blur(15px);border:1px solid rgba(255,215,0,.3);padding:30px;border-radius:20px;margin:20px;width:90%;max-width:450px;text-align:center;box-shadow:0 0 50px rgba(255,215,0,.3)}
        .preview-circle{width:300px;height:300px;border-radius:50%;border:10px solid #FFD700;overflow:hidden;margin:40px 0;box-shadow:0 0 100px #FFD700,inset 0 0 80px rgba(255,215,0,.4);cursor:pointer}
        .preview-circle img{width:100%;height:100%;object-fit:cover}
        .hall-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;width:90%;max-width:1200px;margin:40px 0}
        .hall-item{border:2px solid #FFD700;border-radius:15px;overflow:hidden;box-shadow:0 0 40px rgba(255,215,0,.5);transition:.4s}
        .hall-item:hover{transform:scale(1.05);box-shadow:0 0 80px rgba(255,215,0,.9)}
        .hall-item img{width:100%;height:300px;object-fit:cover}
        .nav-btn{position:fixed;bottom:30px;background:rgba(255,215,0,.2);border:1px solid #FFD700;color:#FFD700;padding:12px 25px;border-radius:30px;z-index:100}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    </style>
</head>
<body>
    <canvas id="particles-canvas"></canvas>

    <!-- ÿµŸÅÿ≠Ÿá ÿßÿµŸÑ€å -->
    <div id="page-main" class="page active">
        <h1 class="main-title">THE VOID</h1>
        <input type="text" id="burden" placeholder="YOUR ETERNAL BURDEN...">
        <button class="btn" onclick="goToPlans()">ASCEND</button>
    </div>

    <!-- ÿµŸÅÿ≠Ÿá ŸæŸÑŸÜ‚ÄåŸáÿß -->
    <div id="page-plans" class="page">
        <div class="preview-circle" onclick="document.getElementById('photo-upload').click()">
            <img id="preview-img" src="" style="display:none;" alt="preview">
        </div>
        <input type="file" id="photo-upload" accept="image/*" style="display:none;" onchange="previewPhoto(event)">

        <div class="glass-card">
            <button class="btn btn-luck" onclick="buy('kings-luck')">KING'S LUCK ‚Äì 199 ‚≠ê</button>
        </div>
        <div class="glass-card">
            <button class="btn" onclick="buy('divine')">DIVINE ‚Äì 150 ‚≠ê</button>
        </div>
        <div class="glass-card">
            <button class="btn" onclick="buy('celestial')">CELESTIAL ‚Äì 299 ‚≠ê</button>
        </div>
        <div class="glass-card">
            <button class="btn" onclick="buy('legendary')">LEGENDARY ‚Äì 499 ‚≠ê</button>
        </div>

        <button class="btn" onclick="shareToStory()">SHARE TO STORY</button>
        <button class="nav-btn" style="left:30px;" onclick="goToHall()">HALL OF FAME</button>
        <button class="nav-btn" style="right:30px;" onclick="goToMarket()">MARKETPLACE</button>
        <button class="nav-btn" style="left:50%;transform:translateX(-50%);" onclick="goToPanel()">MY PANEL</button>
    </div>

    <!-- ÿµŸÅÿ≠Ÿá Hall of Fame -->
    <div id="page-hall" class="page">
        <h1 class="main-title">HALL OF ETERNITY</h1>
        <div class="hall-grid" id="hall-grid"></div>
        <button class="nav-btn" onclick="goToPlans()">BACK</button>
    </div>

    <!-- ÿµŸÅÿ≠Ÿá Marketplace -->
    <div id="page-market" class="page">
        <h1 class="main-title">VOID MARKETPLACE</h1>
        <div class="glass-card">
            <p>List your Legendary for sale</p>
            <input type="number" id="sale-price" placeholder="Price in ‚≠ê">
            <button class="btn" onclick="listForSale()">LIST FOR SALE</button>
        </div>
        <div class="hall-grid" id="market-grid"></div>
        <button class="nav-btn" onclick="goToPlans()">BACK</button>
    </div>

    <!-- ÿµŸÅÿ≠Ÿá ŸæŸÜŸÑ ⁄©ÿßÿ±ÿ®ÿ±€å -->
    <div id="page-panel" class="page">
        <h1 class="main-title">YOUR ETERNAL ARCHIVE</h1>
        <div class="glass-card">
            <p>Referrals: <span id="ref-count">0</span> (Discount: <span id="discount">0%</span>)</p>
            <p>Your DNA Codes:</p>
            <div id="user-dna-list"></div>
        </div>
        <div class="hall-grid" id="user-collection"></div>
        <button class="nav-btn" onclick="goToPlans()">BACK</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ---------- particles ----------
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 0.4 - 0.2;
                this.speedY = Math.random() * 0.4 - 0.2;
                this.opacity = Math.random() * 0.5 + 0.3;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255,255,255,${this.opacity})`;
                ctx.fill();
            }
        }
        for (let i = 0; i < 150; i++) particles.push(new Particle());
        function animateParticles() {
            ctx.fillStyle = 'rgba(0,0,0,.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // ---------- navigation ----------
        function goTo(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function goToPlans() { goTo('page-plans'); }
        function goToHall() { goTo('page-hall'); loadHall(); }
        function goToMarket() { goTo('page-market'); loadMarket(); }
        function goToPanel() { goTo('page-panel'); loadPanel(); }

        // ---------- photo ----------
        let currentPhoto = null;
        function previewPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = document.getElementById('preview-img');
                img.src = ev.target.result;
                img.style.display = 'block';
                currentPhoto = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ---------- api ----------
        async function buy(type) {
            const burden = document.getElementById('burden').value || 'Eternal Sovereign';
            const body = {
                u: tg.initDataUnsafe.user.id,
                b: burden,
                type: type,
                p: currentPhoto
            };
            const res = await fetch('/create_stars_invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (data.url) tg.openInvoice(data.url);
        }

        function shareToStory() {
            const text = "I ascended in THE VOID and forged an eternal masterpiece! üåå";
            const url = `https://t.me/${tg.initDataUnsafe.user.username}?start=ref_${tg.initDataUnsafe.user.id}`;
            tg.shareToStory(url, { text });
        }

        async function loadHall() {
            const res = await fetch('/api/hall-of-fame');
            const data = await res.json();
            const grid = document.getElementById('hall-grid');
            grid.innerHTML = '';
            data.winners.forEach(w => {
                const item = document.createElement('div');
                item.className = 'hall-item';
                item.innerHTML = `
                    <img src="/static/placeholder.png" alt="cert">
                    <div style="padding:10px;">
                        <div>${w.level}</div>
                        <div>${w.burden}</div>
                    </div>
                `;
                grid.appendChild(item);
            });
        }
        async function loadMarket() {
            // ŸÜŸÖŸàŸÜŸá static
            document.getElementById('market-grid').innerHTML = '<div class="hall-item"><img src="/static/placeholder.png" alt="sale"><div style="padding:10px;">Coming Soon</div></div>';
        }
        async function loadPanel() {
            // ŸÜŸÖŸàŸÜŸá static
            document.getElementById('ref-count').innerText = '0';
            document.getElementById('discount').innerText = '0%';
        }
        function listForSale() {
            alert('Listing will be available soon!');
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>

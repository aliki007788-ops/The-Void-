<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE VOID - ETERNAL ASCENSION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Ù‡Ù…Ù‡ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø­ÙØ¸ Ø´ÙˆØ¯ */
        /* ... */
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <!-- Navigation Trigger -->
    <div class="nav-trigger" onclick="toggleMenu()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav-bar" id="bottomNavBar">
        <div class="nav-item" onclick="showSection('home')">
            <i>ğŸ›ï¸</i>
            <span>TEMPLE</span>
        </div>
        <div class="nav-item" onclick="showSection('profile')">
            <i>ğŸ‘¤</i>
            <span>SOUL</span>
        </div>
        <div class="nav-item" onclick="showSection('hall')">
            <i>ğŸ†</i>
            <span>HALL</span>
        </div>
        <div class="nav-item" onclick="showSection('auction')">
            <i>ğŸ”¨</i>
            <span>AUCTION</span>
        </div>
        <div class="nav-item" onclick="showSection('leaderboard')">
            <i>ğŸŒŸ</i>
            <span>RANKS</span>
        </div>
    </div>

    <!-- Step 1: Sacrifice -->
    <div id="step1" class="stage">
        <h1 class="main-title">THE VOID</h1>
        <div class="input-wrapper">
            <input type="text" id="sacrifice" class="sacrifice-input" placeholder="WHAT DO YOU SACRIFICE?" maxlength="50" autocomplete="off">
        </div>
        <button class="ascend-btn" onclick="ascend()">ASCEND</button>
    </div>

    <!-- Step 2: Mint -->
    <div id="step2" class="stage">
        <h2 class="section-title" id="step2Title">ETERNAL VOID</h2>
        
        <div class="glass-card">
            <div class="tabs">
                <div class="tab free active" onclick="openTab('eternal')">FREE</div>
                <div class="tab" onclick="openTab('divine')">199 â­</div>
                <div class="tab" onclick="openTab('celestial')">299 â­</div>
                <div class="tab" onclick="openTab('legendary')">499 â­</div>
            </div>
            
            <div id="eternal" class="tab-content active">
                <h3 class="plan-title">ETERNAL VOID</h3>
                <p class="plan-description">SACRIFICE YOUR BURDEN TO THE ETERNAL VOID<br>NO SOUL IMAGE REQUIRED â€“ PURE ASCENSION INTO DARKNESS</p>
                <div class="free-info" id="freeInfo">
                    DAILY 2 FREE ASCENSIONS AVAILABLE
                </div>
            </div>
            
            <div id="divine" class="tab-content">
                <h3 class="plan-title">DIVINE LEVEL</h3>
                <p class="plan-description">UPLOAD YOUR SOUL IMAGE FOR DIVINE ASCENSION<br>ROYAL GOLDEN EFFECTS AND CELESTIAL AURA</p>
                <div id="previewContainerDivine" class="preview-container">
                    <div class="default-avatar" id="defaultAvatarDivine">ğŸ‘¤</div>
                    <img id="previewDivine" class="preview-img" style="display: none;">
                </div>
                <label class="upload-label" onclick="document.getElementById('uploadDivine').click()">
                    ğŸ“¸ UPLOAD YOUR SOUL
                </label>
                <input type="file" id="uploadDivine" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewDivine', 'previewContainerDivine')">
            </div>
            
            <div id="celestial" class="tab-content">
                <h3 class="plan-title">CELESTIAL LEVEL</h3>
                <p class="plan-description">UPLOAD YOUR SOUL IMAGE FOR CELESTIAL ASCENSION<br>NEBULA EFFECTS AND COSMIC RADIANCE</p>
                <div id="previewContainerCelestial" class="preview-container">
                    <div class="default-avatar" id="defaultAvatarCelestial">ğŸ‘¤</div>
                    <img id="previewCelestial" class="preview-img" style="display: none;">
                </div>
                <label class="upload-label" onclick="document.getElementById('uploadCelestial').click()">
                    ğŸ“¸ UPLOAD YOUR SOUL
                </label>
                <input type="file" id="uploadCelestial" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewCelestial', 'previewContainerCelestial')">
            </div>
            
            <div id="legendary" class="tab-content">
                <h3 class="plan-title">LEGENDARY LEVEL</h3>
                <p class="plan-description">UPLOAD YOUR SOUL IMAGE FOR LEGENDARY ASCENSION<br>ULTIMATE VOID EFFECTS AND ETERNAL POWER</p>
                <div id="previewContainerLegendary" class="preview-container">
                    <div class="default-avatar" id="defaultAvatarLegendary">ğŸ‘¤</div>
                    <img id="previewLegendary" class="preview-img" style="display: none;">
                </div>
                <label class="upload-label" onclick="document.getElementById('uploadLegendary').click()">
                    ğŸ“¸ UPLOAD YOUR SOUL
                </label>
                <input type="file" id="uploadLegendary" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewLegendary', 'previewContainerLegendary')">
            </div>
        </div>
        
        <!-- Action Buttons Outside Card -->
        <div class="action-buttons-container" id="actionButtonsContainer">
            <div class="action-buttons">
                <button class="mint-btn free" onclick="mintNFT('eternal')" id="mintFreeBtn">MINT FREE NFT</button>
                <button class="mint-btn" onclick="mintNFT('divine')" id="paidMintBtn">MINT NFT - 199 â­</button>
                <button class="kings-luck-btn" onclick="mintNFT('kings-luck')">KING'S LUCK - 249 â­</button>
            </div>
        </div>
        
        <!-- NFT Preview Modal -->
        <div id="nftPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: rgba(20,20,20,0.95); padding: 30px; border-radius: 20px; border: 2px solid var(--gold-primary); max-width: 90%; max-height: 90%; overflow: auto;">
                <div style="text-align: right; margin-bottom: 20px;">
                    <button onclick="document.getElementById('nftPreviewModal').style.display = 'none'" style="background: none; border: none; color: var(--gold-primary); font-size: 2rem; cursor: pointer;">Ã—</button>
                </div>
                <img id="nftPreviewImage" style="max-width: 100%; max-height: 400px; border-radius: 10px;">
                <div id="nftPreviewText" style="margin-top: 20px; color: var(--gold-primary); text-align: center;"></div>
                <button onclick="saveNFT()" style="background: var(--gold-primary); color: black; border: none; padding: 15px 30px; border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold;">SAVE NFT</button>
            </div>
        </div>
        
        <!-- Scroll Indicator -->
        <div class="scroll-indicator">
            <div class="scroll-text">SCROLL</div>
            <div class="scroll-line"></div>
        </div>
    </div>

    <!-- News Ticker -->
    <div class="news-ticker">
        <div class="ticker-track" id="tickerTrack"></div>
    </div>

    <script>
        // Telegram WebApp Initialization
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Global variables
        let particles = [];
        let state = 'idle';
        let currentPlan = 'eternal';
        let freeMintsLeft = 2;
        let currentUserPhoto = null;
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ø¢Ø¯Ø±Ø³ backend - Ø¯Ø± production ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
        const BACKEND_URL = 'http://localhost:5000'; // ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø´Ù…Ø§
        
        // Initialize canvas
        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = initCanvas;
        initCanvas();
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú†Ú© Ú©Ø±Ø¯Ù† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡
        async function checkDailyLimit() {
            const userId = tg.initDataUnsafe.user?.id || 0;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/check-limit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId })
                });
                
                const data = await response.json();
                if (data.remaining_free !== undefined) {
                    freeMintsLeft = data.remaining_free;
                    updateFreeQuota();
                }
            } catch (error) {
                console.error('Error checking limit:', error);
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        function updateFreeQuota() {
            const freeInfo = document.getElementById('freeInfo');
            if (freeInfo) {
                freeInfo.innerHTML = `DAILY FREE ASCENSIONS: <span style="color: #00ff88;">${freeMintsLeft}</span> REMAINING`;
            }
        }
        
        // Particle class Ùˆ animate function Ù…Ø«Ù„ Ù‚Ø¨Ù„ÛŒ...
        
        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ NFT
        async function mintNFT(plan) {
            const burden = document.getElementById('sacrifice').value.trim() || 'Unknown Burden';
            const userId = tg.initDataUnsafe.user?.id || 0;
            
            tg.MainButton.showProgress();
            
            try {
                if (plan === 'eternal') {
                    // ØªÙˆÙ„ÛŒØ¯ NFT Ø±Ø§ÛŒÚ¯Ø§Ù†
                    const response = await fetch(`${BACKEND_URL}/api/generate-free`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user_id: userId,
                            burden: burden
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Ù†Ù…Ø§ÛŒØ´ NFT Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
                        showNFTPreview(data.image, "ğŸ‰ FREE VOID NFT CREATED!");
                        freeMintsLeft = data.remaining_free;
                        updateFreeQuota();
                    } else {
                        tg.showAlert(`âŒ Error: ${data.error}`);
                    }
                    
                } else if (plan === 'kings-luck') {
                    // King's Luck - Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ Ù¾Ù„Ù†
                    const plans = ['eternal', 'divine', 'celestial', 'legendary'];
                    const weights = [0.3, 0.35, 0.25, 0.1];
                    let random = Math.random();
                    let selectedIndex = 0;
                    let weightSum = 0;
                    
                    for(let i = 0; i < weights.length; i++) {
                        weightSum += weights[i];
                        if (random <= weightSum) {
                            selectedIndex = i;
                            break;
                        }
                    }
                    
                    const wonPlan = plans[selectedIndex];
                    tg.showAlert(`ğŸ‘‘ KING'S LUCK: ${wonPlan.toUpperCase()} ASCENSION GRANTED!`);
                    
                    if (wonPlan === 'eternal') {
                        if (freeMintsLeft > 0) {
                            mintNFT('eternal');
                        } else {
                            tg.showAlert('â³ No free mints left today for Eternal plan');
                        }
                    } else {
                        // Ø¨Ø±Ø§ÛŒ Ù¾Ù„Ù† Ù¾ÙˆÙ„ÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¹Ú©Ø³ Ø¯Ø§Ø±ÛŒÙ…
                        const preview = document.getElementById(`preview${wonPlan.charAt(0).toUpperCase() + wonPlan.slice(1)}`);
                        if (preview.src && !preview.src.includes('default')) {
                            await generatePaidNFT(wonPlan, preview.src, burden, userId);
                        } else {
                            tg.showAlert('ğŸ“¸ Please upload photo first for this plan');
                        }
                    }
                    
                } else {
                    // ØªÙˆÙ„ÛŒØ¯ NFT Ù¾ÙˆÙ„ÛŒ
                    const preview = document.getElementById(`preview${plan.charAt(0).toUpperCase() + plan.slice(1)}`);
                    
                    if (!preview.src || preview.src.includes('data:image') === false) {
                        tg.showAlert('ğŸ“¸ Upload your soul image first for paid ascension.');
                        tg.MainButton.hideProgress();
                        return;
                    }
                    
                    await generatePaidNFT(plan, preview.src, burden, userId);
                }
                
            } catch (error) {
                console.error('Mint error:', error);
                tg.showAlert('âŒ Void is unstable. Try again.');
            } finally {
                tg.MainButton.hideProgress();
            }
        }
        
        // ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ NFT Ù¾ÙˆÙ„ÛŒ
        async function generatePaidNFT(plan, userImage, burden, userId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-paid`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        burden: burden,
                        plan: plan,
                        image: userImage
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Ù†Ù…Ø§ÛŒØ´ NFT Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
                    showNFTPreview(data.image, `ğŸŒŸ ${plan.toUpperCase()} NFT CREATED!`);
                    
                    // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Telegram Stars Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
                    setTimeout(() => {
                        tg.showAlert(`ğŸ’° Invoice for ${getPlanPrice(plan)} Stars created. Complete payment in Telegram.`);
                    }, 1000);
                    
                } else {
                    tg.showAlert(`âŒ Error: ${data.error}`);
                }
                
            } catch (error) {
                console.error('Paid NFT error:', error);
                tg.showAlert('âŒ Failed to generate paid NFT');
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ NFT
        function showNFTPreview(imageData, message) {
            const modal = document.getElementById('nftPreviewModal');
            const img = document.getElementById('nftPreviewImage');
            const text = document.getElementById('nftPreviewText');
            
            img.src = imageData;
            text.innerHTML = message;
            modal.style.display = 'flex';
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø°Ø±Ø§Øª Ø¬Ø´Ù†
            createCelebrationParticles();
        }
        
        // ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ NFT
        function saveNFT() {
            const img = document.getElementById('nftPreviewImage');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `void-nft-${Date.now()}.png`;
            link.click();
            tg.showAlert('âœ… NFT saved to your device!');
        }
        
        // ØªØ§Ø¨Ø¹ Ù‚ÛŒÙ…Øª Ù¾Ù„Ù†
        function getPlanPrice(plan) {
            const prices = {
                divine: 199,
                celestial: 299,
                legendary: 499,
                'kings-luck': 249
            };
            return prices[plan] || 0;
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ø°Ø±Ø§Øª Ø¬Ø´Ù†
        function createCelebrationParticles() {
            for(let i = 0; i < 100; i++) {
                const p = new Particle('explode', canvas.width / 2, canvas.height / 2);
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 20 + 5;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed;
                p.size = Math.random() * 3 + 1;
                p.color = 'rgba(212, 175, 55,';
                p.alpha = 1;
                p.gravity = 0.05;
                p.friction = 0.97;
                particles.push(p);
            }
        }
        
        // Particle class (Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ)
        class Particle {
            constructor(type, x, y) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.vx = 0;
                this.vy = 0;
                this.size = 2;
                this.color = 'rgba(212, 175, 55,';
                this.alpha = 1;
                this.gravity = 0;
                this.friction = 1;
                this.life = 100;
            }
            
            update() {
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.alpha = this.life / 100;
                
                return this.life > 0;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color + this.alpha + ')';
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color + '0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        // Animation loop (Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ)
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars background
            for(let i = 0; i < 100; i++) {
                const x = (i * 37) % canvas.width;
                const y = (i * 29) % canvas.height;
                const size = Math.sin(Date.now() * 0.001 + i) * 0.5 + 1;
                const alpha = Math.sin(Date.now() * 0.001 + i * 0.5) * 0.3 + 0.4;
                
                ctx.fillStyle = `rgba(212, 175, 55, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw particles
            particles.forEach((particle, index) => {
                if (particle.update()) {
                    particle.draw();
                } else {
                    particles.splice(index, 1);
                }
            });
            
            requestAnimationFrame(animate);
        }
        animate();
        
        // Initialize
        checkDailyLimit();
        updateFreeQuota();
        
        // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ (toggleMenu, showSection, openTab, previewImage, initNewsTicker) Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ...
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE VOID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        :root { --gold: #D4AF37; --bg: #050505; --glass: rgba(255, 255, 255, 0.05); }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Cinzel', serif; overflow: hidden; }
        
        /* Ø·Ø±Ø§Ø­ÛŒ ØµÙØ­Ø§Øª */
        .page { display: none; height: 100vh; padding: 20px; box-sizing: border-box; overflow-y: auto; text-align: center; padding-bottom: 100px; }
        .active { display: block; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† */
        .nav-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: rgba(0,0,0,0.9); border-top: 1px solid var(--gold); z-index: 100; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #666; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active-nav { color: var(--gold); text-shadow: 0 0 10px var(--gold); }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ */
        .sacrifice-input { background: transparent; border: 1px solid var(--gold); color: white; padding: 15px; width: 80%; margin: 20px 0; font-family: 'Cinzel'; }
        .gold-btn { background: var(--gold); color: black; border: none; padding: 12px 30px; font-weight: bold; margin-top: 10px; cursor: pointer; box-shadow: 0 0 15px var(--gold); }
        .luck-btn { background: transparent; border: 2px solid var(--gold); color: var(--gold); padding: 10px 20px; margin-top: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px var(--gold); } 50% { box-shadow: 0 0 20px var(--gold); } 100% { box-shadow: 0 0 5px var(--gold); } }

        .grid-60 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .grid-60 img { width: 100%; border: 1px solid var(--glass); }

        .ref-slots { display: flex; justify-content: space-around; margin: 30px 0; }
        .slot { width: 40px; height: 40px; border: 1px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.3; }
        .slot.filled { opacity: 1; background: var(--gold); color: black; }
    </style>
</head>
<body>
    <canvas id="stars"></canvas>

    <section id="page-altar" class="page active">
        <h1 style="color: var(--gold); margin-top: 50px;">THE VOID</h1>
        <p>What do you surrender?</p>
        <textarea id="sacrifice" class="sacrifice-input" placeholder="Type your burden..."></textarea>
        <br>
        <button class="gold-btn" onclick="ascend('Eternal')">ASCEND (70 Stars)</button>
        <br>
        <button class="luck-btn" onclick="ascend('Luck')">KING'S LUCK (30 Stars)</button>
    </section>

    <section id="page-hall" class="page">
        <h2 class="gold-text">ETERNAL HALL</h2>
        <div id="gallery" class="grid-60"></div>
    </section>

    <section id="page-ref" class="page">
        <h2>BROTHERHOOD</h2>
        <p>Invite 6 souls for a free Divine Ascension</p>
        <div class="ref-slots" id="ref-container"></div>
        <button class="gold-btn" onclick="copyRef()">COPY INVITE LINK</button>
    </section>

    <nav class="nav-bar">
        <div class="nav-item active-nav" onclick="switchPage('altar', this)">MANTRA</div>
        <div class="nav-item" onclick="switchPage('hall', this)">HALL</div>
        <div class="nav-item" onclick="switchPage('ref', this)">BROTHERS</div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        function switchPage(p, el) {
            document.querySelectorAll('.page').forEach(s => s.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            el.classList.add('active-nav');
        }

        async function ascend(type) {
            const burden = document.getElementById('sacrifice').value;
            if(!burden) return tg.showAlert("The Void requires words.");
            
            const payload = {
                u: tg.initDataUnsafe.user.id,
                b: burden,
                level: type === 'Luck' ? 'Eternal' : type,
                is_luck: type === 'Luck'
            };

            const res = await fetch('/api/create_invoice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.url) tg.openInvoice(data.url);
        }

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø±ÙØ±Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ú¯Ø§Ù„Ø±ÛŒ
        async function loadData() {
            const res = await fetch(`/api/init/${tg.initDataUnsafe.user.id}`);
            const data = await res.json();
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙØ±Ø§Ù„
            const container = document.getElementById('ref-container');
            for(let i=1; i<=6; i++) {
                let div = document.createElement('div');
                div.className = i <= data.ref_count ? 'slot filled' : 'slot';
                div.innerText = i === 6 ? 'ğŸ' : i;
                container.appendChild(div);
            }

            // Ù†Ù…Ø§ÛŒØ´ ØªØµØ§ÙˆÛŒØ± Ú¯Ø§Ù„Ø±ÛŒ
            const gallery = document.getElementById('gallery');
            data.top_60.forEach(item => {
                let img = document.createElement('img');
                img.src = item.path;
                gallery.appendChild(img);
            });
        }
        loadData();
    </script>
</body>
</html>

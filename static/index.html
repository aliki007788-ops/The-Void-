<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>THE VOID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        body { background: #000; color: #FFD700; font-family: 'Cinzel', serif; text-align: center; margin: 0; overflow: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .stage { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 1s; }
        
        /* ØªÛŒØªØ± ÛŒÚ© Ø®Ø·ÛŒ Ùˆ Ø¨Ø§Ù„Ø§ØªØ± */
        .main-title { font-size: 2.2rem; letter-spacing: 12px; margin-bottom: 80px; white-space: nowrap; text-shadow: 0 0 20px rgba(255,215,0,0.4); }
        
        input[type="text"] { background: none; border: none; border-bottom: 1px solid #333; color: #FFD700; font-size: 1.2rem; text-align: center; width: 70%; outline: none; font-family: monospace; }
        .btn-large { border: 1px solid #FFD700; padding: 18px 60px; background: rgba(0,0,0,0.4); color: #FFD700; cursor: pointer; letter-spacing: 5px; font-weight: bold; margin-top: 40px; transition: 0.3s; }
        
        #step2 { display: none; opacity: 0; }
        .option-card { background: rgba(15,15,15,0.9); border: 1px solid #222; padding: 20px; border-radius: 5px; width: 80%; margin-top: 20px; backdrop-filter: blur(10px); }
        .price-display { font-size: 3rem; font-weight: bold; margin: 10px 0; color: #FFD700; }
        .diamond { color: #00d4ff; text-shadow: 0 0 15px #00d4ff; }
    </style>
</head>
<body>
    <canvas id="cvs"></canvas>
    <audio id="snd-boom" src="https://assets.mixkit.co/active_storage/sfx/2895/2895-preview.mp3"></audio>

    <div id="step1" class="stage">
        <h1 class="main-title">THE VOID</h1>
        <input type="text" id="burden" placeholder="ENTER SACRIFICE" maxlength="15">
        <button class="btn-large" onclick="ascend()">ASCEND</button>
    </div>

    <div id="step2" class="stage">
        <h3 id="grade-label" style="letter-spacing: 3px; color: #888;">ETERNAL GRADE</h3>
        <div class="price-display"><span id="price-amt">70</span> <span class="diamond">ðŸ’Ž</span></div>
        <div class="option-card">
            <label style="cursor: pointer; border: 1px dashed #444; padding: 10px; display: block; margin-bottom: 15px;">
                <input type="file" id="file-up" style="display:none" onchange="refresh()">
                <span id="file-text">UPLOAD SOUL IMAGE</span>
            </label>
            <label><input type="checkbox" id="prof-check" onchange="refresh()"> USE PROFILE PHOTO</label>
        </div>
        <button class="btn-large" onclick="mint()">MINT NFT</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const canvas = document.getElementById('cvs'); const ctx = canvas.getContext('2d');
        let stars = [], particles = [], state = 'idle';

        function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = init; init();
        for(let i=0; i<150; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*1.5, o: Math.random()});

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            stars.forEach(s => { ctx.fillStyle = `rgba(255,255,255,${s.o})`; ctx.fillRect(s.x, s.y, s.s, s.s); });
            
            particles.forEach((p, i) => {
                ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.z, 0, Math.PI*2); ctx.fill();
                if(state==='exploding') { p.x+=p.vx; p.y+=p.vy; p.z*=0.97; }
                else if(state==='imploding') { p.x+=(canvas.width/2-p.x)*0.15; p.y+=(canvas.height/2-p.y)*0.15; p.z*=0.95; }
                if(p.z<0.1) particles.splice(i,1);
            });
            requestAnimationFrame(draw);
        }
        draw();

        function ascend() {
            if(!document.getElementById('burden').value) return tg.showAlert("VOID REQUIRES A NAME");
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('snd-boom').play();
            
            state = 'exploding';
            for(let i=0; i<100; i++) particles.push({
                x: canvas.width/2, y: canvas.height/2, 
                vx: (Math.random()-0.5)*30, vy: (Math.random()-0.5)*30, 
                z: 4, c: '#FFD700'
            });

            document.getElementById('step1').style.opacity = 0;
            setTimeout(() => {
                state = 'imploding'; // Ø°Ø±Ø§Øª Ø¨Ù‡ Ù…Ø±Ú©Ø² Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ù†Ø¯
                document.getElementById('step1').style.display = 'none';
                const s2 = document.getElementById('step2');
                s2.style.display = 'flex';
                setTimeout(() => { s2.style.opacity = 1; }, 100);
            }, 700);
        }

        function refresh() {
            const prem = document.getElementById('file-up').files[0] || document.getElementById('prof-check').checked;
            document.getElementById('price-amt').innerText = prem ? "120" : "70";
            document.getElementById('grade-label').innerText = prem ? "DIVINE GRADE" : "ETERNAL GRADE";
            document.getElementById('grade-label').style.color = prem ? "#FFD700" : "#888";
            tg.HapticFeedback.selectionChanged();
        }

        async function mint() {
            tg.MainButton.showProgress();
            const b = document.getElementById('burden').value;
            const file = document.getElementById('file-up').files[0];
            let pData = null;
            if(file) {
                pData = await new Promise(r => {
                    const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file);
                });
            }
            const d = btoa(JSON.stringify({ u: tg.initDataUnsafe.user?.id, b: b, p: pData, prof: document.getElementById('prof-check').checked }));
            const res = await fetch('/create_stars_invoice?d=' + d);
            const j = await res.json();
            if(j.url) tg.openInvoice(j.url, s => { if(s==='paid') tg.close(); });
            else if(j.free) { tg.showAlert("DIVINE ACCESS GRANTED"); tg.close(); }
            tg.MainButton.hideProgress();
        }
    </script>
</body>
</html>

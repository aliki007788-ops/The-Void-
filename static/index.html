<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE VOID - Divine Ascension</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP&family=Amiri&display=swap');
        body, html { margin: 0; padding: 0; height: 100%; overflow-x: hidden; background: #000; color: #FFD700; font-family: 'Cinzel', serif; scroll-behavior: smooth; }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .stage { position: relative; z-index: 10; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; transition: opacity 1s ease; }
        
        /* Language Selector */
        .lang-bar { position: absolute; top: 10px; right: 10px; z-index: 100; display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; width: 150px; }
        .lang-btn { background: rgba(255,215,0,0.1); border: 1px solid #FFD700; color: #FFD700; font-size: 0.7rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; }

        .main-title { font-size: 2.5rem; letter-spacing: 12px; margin-top: 40px; text-shadow: 0 0 30px rgba(255,215,0,0.6); text-align: center; }
        input[type="text"], select { background: rgba(20,20,20,0.8); border: none; border-bottom: 2px solid #333; color: #FFD700; font-size: 1.2rem; text-align: center; width: 85%; padding: 15px 0; margin: 10px 0; outline: none; font-family: inherit; border-radius: 5px; }
        
        .btn { background: transparent; border: 2px solid #FFD700; color: #FFD700; padding: 15px 40px; font-size: 1rem; letter-spacing: 4px; cursor: pointer; margin: 20px 0; transition: 0.4s; z-index: 20; text-transform: uppercase; width: 80%; max-width: 300px; }
        .btn:active { background: #FFD700; color: #000; }
        .btn.luck { border-color: #00ffff; color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }

        .option-box { background: rgba(15,15,15,0.95); border: 1px solid #444; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; backdrop-filter: blur(15px); margin: 15px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .rank-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #333; margin: 5px 0; border-radius: 8px; cursor: pointer; }
        .rank-card.active { border-color: #FFD700; background: rgba(255,215,0,0.1); }
        
        #hall-of-fame { width: 90%; margin-top: 50px; text-align: center; }
        .fame-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .fame-item { border: 1px solid #CDA434; border-radius: 5px; overflow: hidden; height: 140px; background: #111; }

        #step2 { display: none; opacity: 0; }
        .price { font-size: 2.5rem; margin: 15px 0; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .diamond { color: #00ffff; text-shadow: 0 0 20px #00ffff; }
        
        #photo-preview { width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 4px solid #FFD700; margin: 20px 0; display: none; }
    </style>
</head>
<body>
    <div class="lang-bar" id="langBar"></div>
    <canvas id="canvas"></canvas>

    <div id="step1" class="stage">
        <h1 class="main-title" id="t-title">THE VOID</h1>
        <input type="text" id="sacrifice" placeholder="WHAT DO YOU SACRIFICE?" maxlength="50">
        
        <div class="option-box">
            <p style="font-size: 0.8rem; text-align: center;" id="t-rank-select">SELECT YOUR ASCENSION RANK</p>
            <div class="rank-card active" onclick="setRank('common', 0, this)">
                <span>Common</span><span id="t-free">FREE</span>
            </div>
            <div class="rank-card" onclick="setRank('rare', 120, this)">
                <span>Rare (Flux)</span><span>120 ⭐</span>
            </div>
            <div class="rank-card" onclick="setRank('legendary', 299, this)">
                <span>Legendary (3D)</span><span>299 ⭐</span>
            </div>
        </div>

        <button class="btn" onclick="ascend()" id="t-btn-ascend">ASCEND</button>
        <button class="btn luck" onclick="tryLuck()" id="t-btn-luck">KING'S LUCK (30 ⭐)</button>

        <div id="hall-of-fame">
            <h3 id="t-fame">HALL OF FAME</h3>
            <div class="fame-grid" id="fameGrid">
                <div class="fame-item"></div><div class="fame-item"></div><div class="fame-item"></div>
            </div>
        </div>
    </div>

    <div id="step2" class="stage">
        <h2 id="grade">DIVINE GRADE</h2>
        <img id="photo-preview" src="" alt="Soul">
        <div class="price"><span id="amount">120</span><span class="diamond"> ⭐ </span></div>
        
        <div class="option-box">
            <label style="display:block; border:1px dashed #555; padding:15px; cursor:pointer; text-align: center;">
                <span id="t-upload">UPLOAD SOUL IMAGE</span>
                <input type="file" id="upload" accept="image/*" style="display:none;" onchange="handlePhoto(this)">
            </label>
            <div style="margin-top: 15px; text-align: center;">
                <label><input type="checkbox" id="profile" onchange="handlePhoto(null)"> <span id="t-use-prof">USE PROFILE PHOTO</span></label>
            </div>
        </div>
        
        <button class="btn" id="mintBtn" onclick="mint()">MINT NFT</button>
        <p style="color: #666; font-size: 0.7rem; text-align: center; width: 80%;" id="t-nft-note">This certificate is unique and ready for the TON blockchain ecosystem.</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const i18n = {
            en: { title: "THE VOID", sacrifice: "WHAT DO YOU SACRIFICE?", rank: "SELECT RANK", free: "FREE", ascend: "ASCEND", luck: "KING'S LUCK (30 ⭐)", fame: "HALL OF FAME", upload: "UPLOAD SOUL IMAGE", use_prof: "USE PROFILE PHOTO", mint: "MINT DIVINE NFT" },
            fa: { title: "خلأ ابدی", sacrifice: "چه چیزی را فدا می‌کنی؟", rank: "انتخاب رتبه صعود", free: "رایگان", ascend: "صعود", luck: "شانس پادشاه (۳۰ ⭐)", fame: "تالار افتخارات", upload: "بارگذاری تصویر روح", use_prof: "استفاده از عکس پروفایل", mint: "تولید گواهی الهی" },
            ru: { title: "ПУСТОТА", sacrifice: "ЧЕМ ВЫ ЖЕРТВУЕТЕ?", rank: "ВЫБЕРИТЕ РАНГ", free: "БЕСПЛАТНО", ascend: "ВОСХОЖДЕНИЕ", luck: "УДАЧА КОРОЛЯ (30 ⭐)", fame: "ЗАЛ СЛАВЫ", upload: "ЗАГРУЗИТЬ ФОТО", use_prof: "ФОТО ПРОФИЛЯ", mint: "СОЗДАТЬ NFT" },
            es: { title: "EL VACÍO", sacrifice: "¿QUÉ SACRIFICAS?", rank: "ELEGIR RANGO", free: "GRATIS", ascend: "ASCENDER", luck: "SUERTE DEL REY (30 ⭐)", fame: "SALÓN DE LA FAMA", upload: "SUBIR IMAGEN", use_prof: "FOTO DE PERFIL", mint: "MINT NFT DIVINO" },
            ar: { title: "الفراغ الأبدي", sacrifice: "ماذا تضحي؟", rank: "اختر رتبة الصعود", free: "مجاني", ascend: "ارتقاء", luck: "حظ الملك (30 ⭐)", fame: "قاعة المشاهير", upload: "رفع صورة الروح", use_prof: "استخدام صورة الملف", mint: "سك NFT الإلهي" },
            fr: { title: "LE VIDE", sacrifice: "QUE SACRIFIEZ-VOUS ?", rank: "CHOISIR LE RANG", free: "GRATUIT", ascend: "ASCENSION", luck: "CHANCE DU ROI (30 ⭐)", fame: "GALERIE D'HONNEUR", upload: "CHARGER L'IMAGE", use_prof: "PHOTO DE PROFIL", mint: "FORGER NFT" },
            zh: { title: "虚空", sacrifice: "你牺牲了什么？", rank: "选择等级", free: "免费", ascend: "飞升", luck: "国王的运气 (30 ⭐)", fame: "名人堂", upload: "上传灵魂图像", use_prof: "使用个人资料照片", mint: "铸造神圣NFT" }
        };

        let currentLang = 'en';
        let selectedRank = 'common';
        let currentPrice = 0;

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('t-title').innerText = i18n[lang].title;
            document.getElementById('sacrifice').placeholder = i18n[lang].sacrifice;
            document.getElementById('t-rank-select').innerText = i18n[lang].rank;
            document.getElementById('t-free').innerText = i18n[lang].free;
            document.getElementById('t-btn-ascend').innerText = i18n[lang].ascend;
            document.getElementById('t-btn-luck').innerText = i18n[lang].luck;
            document.getElementById('t-fame').innerText = i18n[lang].fame;
            document.getElementById('t-upload').innerText = i18n[lang].upload;
            document.getElementById('t-use-prof').innerText = i18n[lang].use_prof;
            document.getElementById('mintBtn').innerText = i18n[lang].mint;
        }

        const langBar = document.getElementById('langBar');
        Object.keys(i18n).forEach(lang => {
            const b = document.createElement('button');
            b.className = 'lang-btn';
            b.innerText = lang.toUpperCase();
            b.onclick = () => setLang(lang);
            langBar.appendChild(b);
        });

        function setRank(rank, price, el) {
            selectedRank = rank;
            currentPrice = price;
            document.querySelectorAll('.rank-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('amount').innerText = price;
            tg.HapticFeedback.selectionChanged();
        }

        function handlePhoto(input) {
            const preview = document.getElementById('photo-preview');
            if (input && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(input.files[0]);
            } else if (document.getElementById('profile').checked && tg.initDataUnsafe.user?.photo_url) {
                preview.src = tg.initDataUnsafe.user.photo_url;
                preview.style.display = 'block';
            }
        }

        async function tryLuck() {
            const sacrifice = document.getElementById('sacrifice').value.trim();
            if(!sacrifice) return tg.showAlert("Name your burden first.");
            const res = await fetch('/create_stars_invoice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ u: tg.initDataUnsafe.user?.id, b: sacrifice, type: 'luck', price: 30 })
            });
            const data = await res.json();
            if(data.url) tg.openInvoice(data.url, s => { if(s==='paid') tg.showAlert("Fortune favors the bold!"); });
        }

        // --- Existing Animation Code [Source: 58-134] ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let particles = [], stars = [], meteors = [], state = 'idle';
        function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; stars = []; for(let i=0; i<150; i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*1.5, vx:(Math.random()-0.5)*0.4, vy:(Math.random()-0.5)*0.4}); }
        window.onresize = init; init();
        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            stars.forEach(s => { s.x+=s.vx; s.y+=s.vy; if(s.x<0||s.x>canvas.width) s.vx*=-1; if(s.y<0||s.y>canvas.height) s.vy*=-1; ctx.fillStyle='#FFF'; ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); });
            particles.forEach((p, i) => { ctx.fillStyle = '#FFD700'; ctx.globalAlpha = p.alpha || 1; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); if(state==='exploding'){p.x+=p.vx; p.y+=p.vy; p.size*=0.985;} if(p.size<0.5) particles.splice(i,1); });
            requestAnimationFrame(draw);
        }
        draw();

        function ascend() {
            const sacrifice = document.getElementById('sacrifice').value.trim();
            if(!sacrifice) return tg.showAlert("The Void requires a name.");
            tg.HapticFeedback.impactOccurred('heavy');
            state = 'exploding';
            for(let i=0; i<300; i++) {
                const a = Math.random()*Math.PI*2; const s = Math.random()*15+5;
                particles.push({x:canvas.width/2, y:canvas.height/2, vx:Math.cos(a)*s, vy:Math.sin(a)*s, size:Math.random()*5+2});
            }
            if(selectedRank === 'common') {
                setTimeout(() => mint(), 1000);
            } else {
                document.getElementById('step1').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('step1').style.display = 'none';
                    const s2 = document.getElementById('step2');
                    s2.style.display = 'flex'; setTimeout(() => s2.style.opacity = 1, 50);
                }, 800);
            }
        }

        async function mint() {
            const sacrifice = document.getElementById('sacrifice').value.trim();
            const photoInput = document.getElementById('upload');
            let photo = null;
            if(photoInput.files[0]) {
                photo = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(photoInput.files[0]); });
            }
            const res = await fetch('/create_stars_invoice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    u: tg.initDataUnsafe.user?.id || 0, b: sacrifice, p: photo, 
                    rank: selectedRank, price: currentPrice, prof: document.getElementById('profile').checked 
                })
            });
            const data = await res.json();
            if(data.url) tg.openInvoice(data.url, s => { if(s==='paid') tg.close(); });
            else if(data.free) { tg.showAlert("Ascension Complete."); tg.close(); }
        }
    </script>
</body>
</html>

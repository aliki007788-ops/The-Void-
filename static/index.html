<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>THE VOID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        body { background: #000; color: #FFD700; font-family: 'Cinzel', serif; text-align: center; margin: 0; overflow: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .stage { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .main-title { font-size: 3.5rem; letter-spacing: 25px; margin-bottom: 40px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); animation: glow 4s infinite alternate; }
        @keyframes glow { to { text-shadow: 0 0 40px rgba(255, 215, 0, 0.9); } }
        input[type="text"] { background: none; border: none; border-bottom: 1px solid #444; color: #FFD700; font-size: 1.2rem; text-align: center; width: 70%; outline: none; font-family: monospace; }
        .btn-large { border: 1px solid #FFD700; padding: 20px 80px; background: rgba(0,0,0,0.5); color: #FFD700; cursor: pointer; letter-spacing: 8px; font-weight: bold; margin-top: 50px; transition: 0.4s; backdrop-filter: blur(5px); }
        .btn-large:hover { background: #FFD700; color: #000; box-shadow: 0 0 30px #FFD700; }
        #step2 { display: none; opacity: 0; transform: scale(1.1); }
        .option-card { background: rgba(10,10,10,0.8); border: 1px solid #222; padding: 25px; border-radius: 2px; width: 85%; margin-top: 20px; }
        .price-display { font-size: 3.5rem; font-weight: bold; margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .diamond-icon { color: #00d4ff; font-size: 4rem; text-shadow: 0 0 25px #00d4ff; }
    </style>
</head>
<body>
    <canvas id="cvs"></canvas>
    <audio id="snd-whoosh" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="snd-magic" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <div id="step1" class="stage">
        <h1 class="main-title">THE VOID</h1>
        <input type="text" id="burden" placeholder="NAME YOUR SACRIFICE" maxlength="15">
        <button class="btn-large" onclick="ascend()">ASCEND</button>
    </div>

    <div id="step2" class="stage">
        <h3 id="grade-label" style="letter-spacing: 5px; color: #AAA;">ETERNAL GRADE</h3>
        <div class="price-display"><span id="price-amt">70</span> <span class="diamond-icon">ðŸ’Ž</span></div>
        <div class="option-card">
            <label style="cursor: pointer; border: 1px dashed #444; padding: 15px; display: block; margin-bottom: 15px;">
                <input type="file" id="file-up" style="display:none" onchange="refresh()">
                <span id="file-text">UPLOAD SOUL IMAGE</span>
            </label>
            <label style="font-size: 0.8rem; letter-spacing: 2px;">
                <input type="checkbox" id="prof-check" onchange="refresh()"> USE PROFILE PHOTO
            </label>
        </div>
        <button class="btn-large" onclick="mint()">MINT NFT</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const canvas = document.getElementById('cvs'); const ctx = canvas.getContext('2d');
        let stars = [], meteors = [], particles = [], state = 'idle';

        function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = init; init();
        for(let i=0; i<180; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*1.2, o: Math.random()});

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            stars.forEach(s => { ctx.fillStyle = `rgba(255,255,255, ${s.o})`; ctx.fillRect(s.x, s.y, s.s, s.s); s.o += (Math.random()-0.5)*0.02; });
            if(Math.random() < 0.02) meteors.push({x: Math.random()*canvas.width, y: 0, s: Math.random()*3+2, l: Math.random()*50+20});
            meteors.forEach((m, i) => { ctx.strokeStyle = 'rgba(255,215,0,0.3)'; ctx.beginPath(); ctx.moveTo(m.x, m.y); ctx.lineTo(m.x-m.l, m.y+m.l); ctx.stroke(); m.x+=10; m.y+=10; if(m.y>canvas.height) meteors.splice(i,1); });
            particles.forEach((p, i) => { ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.z, 0, Math.PI*2); ctx.fill(); 
                if(state==='exploding'){ p.x+=p.vx; p.y+=p.vy; p.z*=0.98; } else if(state==='imploding'){ p.x+=(canvas.width/2-p.x)*0.1; p.y+=(canvas.height/2-p.y)*0.1; p.z*=0.95; }
                if(p.z<0.1) particles.splice(i,1);
            });
            requestAnimationFrame(draw);
        }
        draw();

        function ascend() {
            if(!document.getElementById('burden').value) return tg.showAlert("VOID REQUIRES A NAME");
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('snd-whoosh').play();
            state='exploding'; for(let i=0; i<150; i++) particles.push({x:canvas.width/2, y:canvas.height/2, vx:(Math.random()-0.5)*25, vy:(Math.random()-0.5)*25, z:Math.random()*3+2, c:'#FFD700'});
            document.getElementById('step1').style.opacity=0;
            setTimeout(() => { state='imploding'; document.getElementById('step1').style.display='none'; const s2=document.getElementById('step2'); s2.style.display='flex'; setTimeout(()=>{s2.style.opacity=1; s2.style.transform='scale(1)';},100); }, 800);
        }

        function refresh() {
            const prem = document.getElementById('file-up').files[0] || document.getElementById('prof-check').checked;
            document.getElementById('price-amt').innerText = prem ? "120" : "70";
            const lbl = document.getElementById('grade-label');
            lbl.innerText = prem ? "DIVINE GRADE" : "ETERNAL GRADE";
            lbl.style.color = prem ? "#FFD700" : "#AAAAAA";
            tg.HapticFeedback.selectionChanged();
        }

        async function mint() {
            tg.MainButton.showProgress();
            const b = document.getElementById('burden').value, file = document.getElementById('file-up').files[0], prof = document.getElementById('prof-check').checked;
            let pData = null;
            if(file) {
                pData = await new Promise(r => {
                    const rd = new FileReader(); rd.onload = e => {
                        const img = new Image(); img.onload = () => {
                            const c = document.createElement('canvas'); c.width=600; c.height=600;
                            c.getContext('2d').drawImage(img,0,0,600,600); r(c.toDataURL('image/jpeg', 0.6));
                        }; img.src = e.target.result;
                    }; rd.readAsDataURL(file);
                });
            }
            const d = btoa(JSON.stringify({ u: tg.initDataUnsafe.user?.id, b: b, p: pData, prof: prof }));
            const res = await fetch('/create_stars_invoice?d=' + d);
            const j = await res.json();
            if(j.url) tg.openInvoice(j.url, s => { if(s==='paid') tg.close(); });
            else if(j.free) { tg.showAlert("ðŸ”± DIVINE ACCESS GRANTED\nYour soul has been recorded."); tg.close(); }
            tg.MainButton.hideProgress();
        }
    </script>
</body>
</html>

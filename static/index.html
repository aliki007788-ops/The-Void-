<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE VOID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #FFD700; font-family: 'Cinzel', serif; }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        .stage { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; transition: opacity 1s ease; box-sizing: border-box; }
        
        /* ØªÛŒØªØ± Ø§ÙˆÙ„ */
        .main-title { font-size: 3rem; font-weight: 900; letter-spacing: 15px; margin-bottom: 40px; text-shadow: 0 0 30px rgba(255,215,0,0.7); }
        
        input[type="text"] { background: transparent; border: none; border-bottom: 2px solid #444; color: #fff; font-size: 1.3rem; text-align: center; width: 85%; padding: 15px 0; outline: none; margin-bottom: 30px; transition: border-color 0.3s; }
        input[type="text"]:focus { border-bottom-color: #FFD700; }

        /* Ø¸Ø±Ù Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ - ØªØ±Ø§Ø²Ø¨Ù†Ø¯ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± Ù…Ø±Ú©Ø² */
        .btn-container { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        
        .btn { background: transparent; border: 2px solid #FFD700; color: #FFD700; padding: 16px; width: 85%; max-width: 340px; font-size: 1rem; font-weight: bold; letter-spacing: 3px; cursor: pointer; transition: 0.3s; position: relative; border-radius: 4px; }
        .btn:active { background: #FFD700; color: #000; }

        /* Ø¯Ú©Ù…Ù‡ Ø´Ø§Ù†Ø³ Ù¾Ø§Ø¯Ø´Ø§Ù‡ Ø¨Ø§ Ø§ÙÚ©Øª Ù†Ø¦ÙˆÙ†ÛŒ */
        .luck-btn { 
            background: linear-gradient(45deg, #6200ea, #d500f9, #FFD700); 
            background-size: 200% 200%;
            border: none; color: white; 
            box-shadow: 0 0 25px rgba(213, 0, 249, 0.6); 
            animation: moveGradient 3s infinite, pulseBtn 1.5s infinite;
        }
        @keyframes moveGradient { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }

        /* ØªØ§Ø¨Ù„ÙˆÛŒ Ø§ÙØªØ®Ø§Ø±Ø§Øª (Û±Û°ØªØ§ÛŒ Ø¢Ø®Ø±) */
        .hall { margin-top: 40px; width: 85%; max-width: 380px; background: rgba(15,15,15,0.7); padding: 15px; border: 1px dashed #333; border-radius: 8px; }
        .hall-item { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 6px 0; border-bottom: 1px solid #222; opacity: 0.8; }
        .rank-DIVINE { color: #FFD700; } .rank-LEGENDARY { color: #d500f9; }

        /* Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± */
        #photo-preview-container { margin-bottom: 15px; display: none; }
        #photo-preview { width: 110px; height: 110px; border-radius: 50%; border: 3px solid #FFD700; object-fit: cover; box-shadow: 0 0 20px #FFD700; }

        /* Ø§Ù„Ù…Ø§Ø³ Ùˆ Ù‚ÛŒÙ…Øª */
        .price-display { font-size: 2.2rem; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: bold; }
        .gem { color: #00ffff; text-shadow: 0 0 20px #00ffff; animation: gemGlow 2s infinite; }
        @keyframes gemGlow { 0%, 100% { opacity: 1; filter: hue-rotate(0deg); } 50% { opacity: 0.6; filter: hue-rotate(45deg); } }

        #step2 { display: none; opacity: 0; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="step1" class="stage">
        <h1 class="main-title">THE VOID</h1>
        <input type="text" id="sacrifice" placeholder="WHAT DO YOU SACRIFICE?" maxlength="40">
        <button class="btn" onclick="ascend()">ASCEND</button>
        
        <div class="hall">
            <p style="text-align:center; font-size:0.9rem; margin-top:0; color:#FFD700;">LATEST ASCENSIONS</p>
            <div id="hall-list">Connecting to the abyss...</div>
        </div>
    </div>

    <div id="step2" class="stage">
        <div id="photo-preview-container">
            <img id="photo-preview" />
        </div>

        <div class="price-display"><span>COST</span><span class="gem">ğŸ’</span></div>

        <div class="btn-container">
            <button class="btn luck-btn" onclick="mint('kings-luck')">KING'S LUCK (199 â­)</button>
            <button class="btn" onclick="mint('divine')">DIVINE (150 â­)</button>
            <button class="btn" onclick="mint('celestial')">CELESTIAL (299 â­)</button>
            <button class="btn" onclick="mint('legendary')">LEGENDARY (499 â­)</button>
            
            <label style="color:#666; font-size:0.8rem; margin-top:10px; cursor:pointer; text-decoration:underline;">
                + UPLOAD SOUL IMAGE
                <input type="file" id="upload" accept="image/*" style="display:none;" onchange="checkPreview()">
            </label>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let particles = [], state = 'idle';

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨ÙˆÙ…
        function initCanvas() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        }
        initCanvas();
        window.onresize = initCanvas;

        // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¹ÛŒÙ† ÙØ§ÛŒÙ„ ÙˆØ±Ø¯)
        async function fetchHall() {
            try {
                const r = await fetch('/api/hall-of-fame'); [cite: 393]
                const d = await r.json();
                const list = document.getElementById('hall-list');
                list.innerHTML = '';
                d.winners.slice(-8).reverse().forEach(w => { [cite: 395]
                    list.innerHTML += `<div class="hall-item"><span>${w.user_id}</span><span class="rank-${w.level.toUpperCase()}">${w.level}</span></div>`;
                });
            } catch(e) { document.getElementById('hall-list').innerHTML = "The Void is silent."; }
        }
        fetchHall();

        function checkPreview() {
            const file = document.getElementById('upload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('photo-preview').src = e.target.result;
                    document.getElementById('photo-preview-container').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                p.alpha -= 0.005;
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                if(p.alpha <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1;
            requestAnimationFrame(draw);
        }
        draw();

        function ascend() {
            const sac = document.getElementById('sacrifice').value;
            if(sac.length < 3) return tg.showAlert("Your burden is too light.");

            // Ø§ÙÚ©Øª Ø°Ø±Ø§Øª Ø¨Ø±Ø§ÛŒ ØªØ´Ú©ÛŒÙ„ Ù…ØªÙ†
            for(let i=0; i<500; i++) {
                particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    vx: (Math.random()-0.5)*25, vy: (Math.random()-0.5)*25,
                    size: Math.random()*4+1, color: '#FFD700', alpha: 1
                });
            }

            document.getElementById('step1').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'flex';
                setTimeout(() => document.getElementById('step2').style.opacity = 1, 100);
            }, 800);
        }

        async function mint(type) {
            const sac = document.getElementById('sacrifice').value;
            const file = document.getElementById('upload').files[0];
            let pData = null;

            if(file) {
                pData = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const res = await fetch('/create_stars_invoice', { [cite: 376]
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    u: tg.initDataUnsafe.user?.id,
                    b: sac,
                    type: type,
                    p: pData
                })
            });
            const data = await res.json();
            if(data.url) tg.openInvoice(data.url); [cite: 375]
        }
    </script>
</body>
</html>
